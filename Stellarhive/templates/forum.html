{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- 左侧边栏：分类导航 -->
        <div class="col-md-3">
            <div class="categories-sidebar">
                <div class="sidebar-header mb-3">
                    <h5 class="sidebar-title">版块导航</h5>
                    {% if current_user.is_authenticated %}
                    <button class="btn btn-primary btn-sm new-post-btn" data-bs-toggle="modal" data-bs-target="#newPostModal">
                        <i class="fas fa-pen"></i> 发帖
                    </button>
                    {% endif %}
                </div>
                <div class="category-list">
                    <a href="{{ url_for('forum', sort=sort_by) }}" 
                       class="category-item {% if not current_category_id %}active{% endif %}">
                        <i class="fas fa-globe"></i>
                        <span>全部</span>
                        <span class="badge bg-secondary">{{ posts.total }}</span>
                    </a>
                    {% for category in categories %}
                    <a href="{{ url_for('forum', category_id=category.id, sort=sort_by) }}" 
                       class="category-item {% if current_category_id == category.id %}active{% endif %}">
                        {% if category.name == '公告通知' %}
                            <i class="fas fa-bullhorn"></i>
                        {% elif category.name == '技术讨论' %}
                            <i class="fas fa-code"></i>
                        {% elif category.name == '资源分享' %}
                            <i class="fas fa-share-alt"></i>
                        {% elif category.name == '问题求助' %}
                            <i class="fas fa-question-circle"></i>
                        {% else %}
                            <i class="fas fa-comments"></i>
                        {% endif %}
                        <span>{{ category.name }}</span>
                        <span class="badge bg-secondary">{{ category.posts.count() }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- 主内容区：帖子列表 -->
        <div class="col-md-9">
            <div class="forum-content">
                <!-- 排序选项 -->
                <div class="sort-options mb-4">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('forum', category_id=current_category_id, sort='newest') }}" 
                           class="btn btn-outline-primary {% if sort_by == 'newest' %}active{% endif %}">
                            <i class="fas fa-clock"></i> 最新
                        </a>
                        <a href="{{ url_for('forum', category_id=current_category_id, sort='popular') }}" 
                           class="btn btn-outline-primary {% if sort_by == 'popular' %}active{% endif %}">
                            <i class="fas fa-fire"></i> 热门
                        </a>
                        <a href="{{ url_for('forum', category_id=current_category_id, sort='no_reply') }}" 
                           class="btn btn-outline-primary {% if sort_by == 'no_reply' %}active{% endif %}">
                            <i class="fas fa-comment-slash"></i> 零回复
                        </a>
                    </div>
                </div>

                <!-- 帖子列表 -->
                <div class="post-list">
                    {% for post in posts.items %}
                    <div class="post-card">
                        <div class="post-meta">
                            <div class="author-avatar">
                                {% if post.author.avatar_filename %}
                                <img src="/avatar/{{ post.author.avatar_filename }}" alt="头像">
                                {% else %}
                                <i class="fas fa-user-circle"></i>
                                {% endif %}
                            </div>
                            <div class="post-info">
                                <h2 class="post-title">
                                    <a href="{{ url_for('forum_post', post_id=post.id) }}" class="text-decoration-none">{{ post.title }}</a>
                                    <span class="category-tag" style="background: {{ '#6366f1' if post.category.name == '技术讨论' else '#3b82f6' if post.category.name == '资源分享' else '#ef4444' if post.category.name == '问题求助' else '#f59e0b' }}">
                                        {{ post.category.name }}
                                    </span>
                                </h2>
                                <div class="post-meta-info">
                                    <span class="author-name">{{ post.author.username }}</span>
                                    <span class="post-time">{{ post.created_time.strftime('%Y-%m-%d %H:%M') }}</span>
                                    {% if post.updated_time != post.created_time %}
                                    <span class="post-edited">(已编辑)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="post-stats">
                            <div class="stat-item">
                                <i class="fas fa-comment"></i>
                                <span>{{ post.comments.count() }}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-eye"></i>
                                <span>{{ post.views }}</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-heart"></i>
                                <span>{{ post.likes.count() }}</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3>暂无帖子</h3>
                        <p>来发布第一个帖子吧！</p>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newPostModal">
                            <i class="fas fa-pen me-1"></i> 发布新帖
                        </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- 分页 -->
                {% if posts.pages > 1 %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if posts.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('forum', category_id=current_category_id, sort=sort_by, page=posts.prev_num) }}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}

                        {% for page_num in range(max(1, posts.page - 2), min(posts.pages + 1, posts.page + 3)) %}
                        <li class="page-item {% if page_num == posts.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('forum', category_id=current_category_id, sort=sort_by, page=page_num) }}">{{ page_num }}</a>
                        </li>
                        {% endfor %}

                        {% if posts.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('forum', category_id=current_category_id, sort=sort_by, page=posts.next_num) }}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 发帖模态框 -->
<div class="modal fade" id="newPostModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">发布新帖</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newPostForm" method="post">
                    <div class="mb-3">
                        <label class="form-label">选择版块</label>
                        <select class="form-select" id="categorySelect" required>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">标题</label>
                        <input type="text" class="form-control" id="postTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">内容</label>
                        <textarea class="form-control" id="postContent" rows="10" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitPost()">发布</button>
            </div>
        </div>
    </div>
</div>

<style>
.categories-sidebar {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1a202c;
    margin: 0;
}

.category-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.category-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    color: #4b5563;
    text-decoration: none;
    transition: all 0.2s;
}

.category-item:hover {
    background: #f1f5f9;
    color: #3b82f6;
}

.category-item.active {
    background: #eff6ff;
    color: #3b82f6;
    font-weight: 500;
}

.category-item i {
    font-size: 1.1rem;
    width: 24px;
    text-align: center;
}

.category-item .badge {
    margin-left: auto;
    font-weight: 500;
    background: #e2e8f0;
    color: #64748b;
}

.forum-content {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.sort-options .btn-group {
    width: 100%;
}

.sort-options .btn {
    flex: 1;
    padding: 0.75rem;
}

.post-card {
    background: #fff;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.post-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    overflow: hidden;
    background: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.author-avatar i {
    font-size: 24px;
    color: #94a3b8;
}

.post-info {
    flex: 1;
}

.post-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.post-title a {
    color: #1a202c;
}

.post-title a:hover {
    color: #3b82f6;
}

.category-tag {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    color: white;
}

.post-meta-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.875rem;
    color: #64748b;
}

.author-name {
    font-weight: 500;
    color: #4b5563;
}

.post-edited {
    color: #94a3b8;
    font-style: italic;
}

.post-stats {
    display: flex;
    gap: 1.5rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    font-size: 0.875rem;
}

.stat-item i {
    font-size: 1rem;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-state-icon {
    font-size: 3rem;
    color: #94a3b8;
    margin-bottom: 1rem;
}

.empty-state h3 {
    font-size: 1.5rem;
    color: #1a202c;
    margin-bottom: 0.5rem;
}

.empty-state p {
    color: #64748b;
    margin-bottom: 1.5rem;
}

.pagination {
    gap: 0.25rem;
}

.pagination .page-link {
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    color: #4b5563;
    border: none;
    font-weight: 500;
}

.pagination .page-item.active .page-link {
    background: #3b82f6;
    color: white;
}

@media (max-width: 768px) {
    .categories-sidebar {
        margin-bottom: 1.5rem;
    }
    
    .post-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .post-stats {
        width: 100%;
        justify-content: space-around;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
    }
    
    .post-meta-info {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .category-tag {
        font-size: 0.7rem;
    }
}
</style>

<script>
// 初始化所有模态框
document.addEventListener('DOMContentLoaded', function() {
    // 获取发帖模态框元素
    const newPostModal = document.getElementById('newPostModal');
    if (newPostModal) {
        // 创建模态框实例
        const modal = new bootstrap.Modal(newPostModal);
        
        // 监听模态框关闭事件，清空表单
        newPostModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
        });
        
        // 监听ESC键
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modal._isShown) {
                modal.hide();
            }
        });
        
        // 监听发布按钮点击事件
        document.querySelector('#newPostModal .btn-primary').addEventListener('click', submitPost);
    }
});

function submitPost() {
    const categoryId = document.getElementById('categorySelect').value;
    const title = document.getElementById('postTitle').value;
    const content = document.getElementById('postContent').value;
    
    if (!title || !content) {
        alert('请填写完整的标题和内容');
        return;
    }
    
    // 获取CSRF令牌
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // 显示加载状态
    const submitBtn = document.querySelector('#newPostModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发布中...';
    
    // 提交表单
    fetch(`/forum/new_post/${categoryId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            title: title,
            content: content
        })
    }).then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        return response.json();
    }).then(data => {
        if (data && data.error) {
            throw new Error(data.error);
        }
        // 发布成功，刷新页面
        window.location.reload();
    }).catch(error => {
        console.error('Error:', error);
        alert(error.message || '发帖失败，请重试');
        // 恢复按钮状态
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// 如果URL中有title和content参数，自动填充到表单
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const title = urlParams.get('title');
    const content = urlParams.get('content');
    
    if (title) {
        document.getElementById('postTitle').value = title;
    }
    if (content) {
        document.getElementById('postContent').value = content;
    }
});
</script>
{% endblock %} 